# name: test/sql/storage/commit_abort.test
# description: Test abort of commit with persistent storage
# group: [storage]

# load the DB from disk
load __TEST_DIR__/commit_abort.db

;
PRAGMA enable_verification

;
CREATE TABLE test (a INTEGER PRIMARY KEY, b INTEGER, c VARCHAR);

;
INSERT INTO test VALUES (11, 22, 'hello'), (13, 22, 'world'), (12, 21, 'test'), (10, NULL, NULL);

# start a transaction for con and con2
;
BEGIN TRANSACTION

;
BEGIN TRANSACTION

# insert the value 14 in both transactions
;
INSERT INTO test VALUES (14, 10, 'con')

;
INSERT INTO test VALUES (15, 10, 'con2')

;
INSERT INTO test VALUES (14, 10, 'con2')

# commit both
# con2 will fail

;
COMMIT

;
COMMIT

;
INSERT INTO test VALUES (15, NULL, NULL)

;
SELECT COUNT(*), COUNT(a), COUNT(b), SUM(a), SUM(b), SUM(LENGTH(c)) FROM test
;
6	6	4	75	75	17

;
SELECT * FROM test ORDER BY a, b, c
;
10	NULL	NULL
11	22	hello
12	21	test
13	22	world
14	10	con
15	NULL	NULL

restart

;
PRAGMA enable_verification

;
SELECT * FROM test ORDER BY a, b, c
;
10	NULL	NULL
11	22	hello
12	21	test
13	22	world
14	10	con
15	NULL	NULL

;
SELECT COUNT(*), COUNT(a), COUNT(b), SUM(a), SUM(b), SUM(LENGTH(c)) FROM test
;
6	6	4	75	75	17

restart

;
PRAGMA enable_verification

;
SELECT COUNT(*), COUNT(a), COUNT(b), SUM(a), SUM(b), SUM(LENGTH(c)) FROM test
;
6	6	4	75	75	17

;
SELECT * FROM test ORDER BY a, b, c
;
10	NULL	NULL
11	22	hello
12	21	test
13	22	world
14	10	con
15	NULL	NULL
