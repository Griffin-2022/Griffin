# name: test/sql/storage/multiple_clients_checkpoing_dependents.test
# description: Try to checkpoint within a transaction that depends on another transactions' changes
# group: [storage]

# load the DB from disk
load __TEST_DIR__/pending_updates.db

;
CREATE TABLE test (i INTEGER);

;
INSERT INTO test SELECT * FROM range(1000000);

;
SELECT MIN(i), MAX(i), COUNT(*) FROM test;
;
0	999999	1000000

;
BEGIN TRANSACTION;

;
UPDATE test SET i=i+1;

;
SELECT MIN(i), MAX(i), COUNT(*) FROM test;
;
1	1000000	1000000

;
SELECT MIN(i), MAX(i), COUNT(*) FROM test;
;
0	999999	1000000

;
SELECT MIN(i), MAX(i), COUNT(*) FROM test;
;
1	1000000	1000000

# con2 now refers back to the undo buffer of con1, but we can still checkpoint
;
FORCE CHECKPOINT

;
SELECT MIN(i), MAX(i), COUNT(*) FROM test;
;
1	1000000	1000000

# force checkpoint has cleared our current transaction, so we can't rollback
;
ROLLBACK

;
CHECKPOINT

;
SELECT MIN(i), MAX(i), COUNT(*) FROM test;
;
1	1000000	1000000

restart

;
SELECT MIN(i), MAX(i), COUNT(*) FROM test;
;
1	1000000	1000000
