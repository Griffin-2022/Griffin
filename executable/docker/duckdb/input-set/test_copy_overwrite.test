# name: test/sql/copy/csv/overwrite/test_copy_overwrite.test
# description: Test copy statement with file overwrite
# group: [overwrite]

# create a table and insert some values
;
CREATE TABLE test (a INTEGER, b VARCHAR(10));

;
INSERT INTO test VALUES (1, 'hello'), (2, 'world '), (3, ' xx');

;
SELECT * FROM test ORDER BY 1;
;
1	hello
2	world 
3	 xx

# copy to the CSV file
;
COPY test TO '__TEST_DIR__/overwrite.csv';
;
3

# now copy to the file again
;
COPY (SELECT * FROM test LIMIT 2) TO '__TEST_DIR__/overwrite.csv';
;
2

# reload the data from the file: it should only have two rows
;
DELETE FROM test;

;
COPY test FROM '__TEST_DIR__/overwrite.csv';
;
2

;
SELECT * FROM test ORDER BY 1;
;
1	hello
2	world 

# test query returning error does not export to file
;
COPY (SELECT i FROM range(1) tbl(i) UNION ALL SELECT concat('hello', i)::INT i FROM range(1) tbl(i)) to '__TEST_DIR__/overwrite.csv';

;
DELETE FROM test;

;
COPY test FROM '__TEST_DIR__/overwrite.csv';
;
2

# this test should still pass as data was not overwritten
;
SELECT * FROM test ORDER BY 1;
;
1	hello
2	world 

# Test USE_TMP_FILE flag
;
COPY (SELECT i FROM range(1) tbl(i) UNION ALL SELECT concat('hello', i)::INT i FROM range(1) tbl(i)) to '__TEST_DIR__/overwrite.csv' (USE_TMP_FILE FALSE);

;
SELECT * FROM '__TEST_DIR__/overwrite.csv';
;
0