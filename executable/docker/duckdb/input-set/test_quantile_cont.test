# name: test/sql/aggregate/aggregates/test_quantile_cont.test
# description: Test QUANTILE_CONT aggregate
# group: [aggregates]

;
PRAGMA enable_verification

# Get around 1% approximately equal for R
;
create table quantile as select range r, random() from range(0,1000000,100) union all values (NULL, 0.1), (NULL, 0.5), (NULL, 0.9) order by 2;

;
SELECT quantile_cont(r, NULL) FROM quantile

;
SELECT quantile_cont(r, 0.5) FROM quantile
;
499950

;
SELECT quantile_cont(r::decimal(10,2), 0.5) FROM quantile
;
499950

;
SELECT quantile_cont(r, 1.0) FROM quantile
;
999900

;
SELECT quantile_cont(r, 0.0) FROM quantile
;
0

;
SELECT quantile_cont(NULL, 0.5) FROM quantile
;
NULL

;
SELECT quantile_cont(42, 0.5) FROM quantile
;
42

;
SELECT quantile_cont(NULL, 0.5)
;
NULL

;
SELECT quantile_cont(42, 0.5)
;
42

# single GROUP
;
SELECT quantile_cont(r, 0.25), quantile_cont(r, 0.5), quantile_cont(r, 0.75) from quantile
;
249975
499950
749925

foreach type decimal(4,1) decimal(8,1) decimal(12,1) decimal(18,1) decimal(24,1)

;
SELECT quantile_cont(d::${type}, 0.25), quantile_cont(d::${type}, 0.5), quantile_cont(d::${type}, 0.75)
FROM range(0,100) tbl(d)
;
24.7	49.5	74.2

endloop

# multiple groups
;
SELECT mod(r,1000) as g, quantile_cont(r, 0.25) FROM quantile GROUP BY 1 ORDER BY 1
;
NULL	NULL
0	249750
100	249850
200	249950
300	250050
400	250150
500	250250
600	250350
700	250450
800	250550
900	250650

# temporal types
;
SELECT quantile_cont('2021-01-01'::TIMESTAMP + interval (r) second, 0.5) FROM quantile
;
2021-01-06 18:52:30

;
SELECT quantile_cont(('1990-01-01'::DATE + interval (r/100) day)::DATE, 0.5) FROM quantile
;
2003-09-09 12:00:00

;
SELECT quantile_cont('00:00:00'::TIME + interval (r/100) second, 0.5) FROM quantile
;
01:23:19.5

;
SELECT quantile_cont(interval (r/100) second, 0.5) FROM quantile
;
01:23:19

# WITH TIME ZONE
;
SELECT quantile_cont(('2021-01-01'::TIMESTAMP + interval (r) second)::TIMESTAMPTZ, 0.5) FROM quantile
;
2021-01-06 18:52:30+00

# constant input
;
SELECT quantile_cont(1, 0.1) FROM quantile
;
1

# empty input
;
SELECT quantile_cont(r, 0.1) FROM quantile WHERE 1=0
;
NULL

;
SELECT quantile_cont(r, -0.1) FROM quantile

;
SELECT quantile_cont(r, 1.1) FROM quantile

;
SELECT quantile_cont(r, "string") FROM quantile

;
SELECT quantile_cont(r, NULL) FROM quantile

;
SELECT quantile_cont(r::string, 0.5) FROM quantile

;
SELECT quantile_cont(r) FROM quantile

;
SELECT quantile_cont(r, 0.1, 50) FROM quantile


;
pragma threads=4

;
PRAGMA verify_parallelism

# single GROUP
;
SELECT quantile_cont(r, 0.25), quantile_cont(r, 0.5), quantile_cont(r, 0.75) from quantile
;
249975
499950
749925

# multiple groups
;
SELECT mod(r,1000) as g, quantile_cont(r, 0.25) FROM quantile GROUP BY 1 ORDER BY 1
;
NULL	NULL
0	249750
100	249850
200	249950
300	250050
400	250150
500	250250
600	250350
700	250450
800	250550
900	250650

# constant input
;
SELECT quantile_cont(1, 0.1) FROM quantile
;
1

# empty input
;
SELECT quantile_cont(r, 0.1) FROM quantile WHERE 1=0
;
NULL

# TINYINT extremes
;
SELECT quantile_cont(t, 0.5) FROM (VALUES (120::TINYINT), (122::TINYINT)) tbl(t)
;
121

;
CREATE TABLE tinyints(t TINYINT);

;
INSERT INTO tinyints VALUES (-127), (-127);

;
SELECT quantile_cont(t, 0.5) FROM tinyints;
;
-127

;
UPDATE tinyints SET t=-t;

;
SELECT quantile_cont(t, 0.5) FROM tinyints;
;
127

# SMALLINT extremes
;
SELECT quantile_cont(t, 0.5) FROM (VALUES (32764::SMALLINT), (32766::SMALLINT)) tbl(t)
;
32765

;
CREATE TABLE smallints(t SMALLINT);

;
INSERT INTO smallints VALUES (-32767), (-32767);

;
SELECT quantile_cont(t, 0.5) FROM smallints;
;
-32767

;
UPDATE smallints SET t=-t;

;
SELECT quantile_cont(t, 0.5) FROM smallints;
;
32767

# INTEGER extremes
;
SELECT quantile_cont(t, 0.5) FROM (VALUES (2147483642::INTEGER), (2147483644::INTEGER)) tbl(t)
;
2147483643

;
CREATE TABLE integers(t INTEGER);

;
INSERT INTO integers VALUES (-2147483647), (-2147483647);

;
SELECT quantile_cont(t, 0.5) FROM integers;
;
-2147483647

;
UPDATE integers SET t=-t;

;
SELECT quantile_cont(t, 0.5) FROM integers;
;
2147483647

# BIGINT extremes
;
SELECT quantile_cont(t, 0.5) FROM (VALUES (9223372036854775794::BIGINT), (9223372036854775796::BIGINT)) tbl(t)
;
9223372036854775795

;
CREATE TABLE bigints(t BIGINT);

;
INSERT INTO bigints VALUES (-9223372036854775800), (-9223372036854775800);

;
SELECT quantile_cont(t, 0.5) FROM bigints;
;
-9223372036854775800

;
UPDATE bigints SET t=-t;

;
SELECT quantile_cont(t, 0.5) FROM bigints;
;
9223372036854775800

;
SELECT quantile_cont(r, random()) FROM quantile
