# name: test/sql/constraints/primarykey/test_pk_concurrency_conflicts.test
# description: PRIMARY KEY and concurency conflicts
# group: [primarykey]

;
CREATE TABLE integers(i INTEGER PRIMARY KEY)

;
INSERT INTO integers VALUES (1), (2), (3)

# con1 starts a transaction and modifies the second value
;
BEGIN TRANSACTION

;
UPDATE integers SET i=4 WHERE i=2

# con2 can't update the second value
;
UPDATE integers SET i=4 WHERE i=2

;
UPDATE integers SET i=5 WHERE i=2

# nor can it delete it
;
DELETE FROM integers WHERE i=2

# we tried to set i=5 in con2 but it failed, we can set it in con1 now though
;
UPDATE integers SET i=5 WHERE i=3

# rollback con1
;
ROLLBACK

# now we can perform the changes in con2
;
BEGIN TRANSACTION

;
UPDATE integers SET i=4 WHERE i=2

;
UPDATE integers SET i=5 WHERE i=3

# check the results, con1 still gets the old results
;
SELECT * FROM integers ORDER BY i
;
1
2
3

;
SELECT * FROM integers ORDER BY i
;
1
4
5

# now commit
;
COMMIT

# check the results again, both get the same (new) results now
;
SELECT * FROM integers ORDER BY i
;
1
4
5

;
SELECT * FROM integers ORDER BY i
;
1
4
5

