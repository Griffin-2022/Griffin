# name: test/optimizer/statistics/statistics_case.test
# description: Test filter propagation in CASE expression
# group: [statistics]

;
PRAGMA enable_verification;

;
PRAGMA explain_output = OPTIMIZED_ONLY;

;
CREATE TABLE integers AS SELECT * FROM (VALUES (1), (2), (3)) tbl(i);

# "i" does not contain null values, so we can statically determine this will not be null
;
EXPLAIN SELECT * FROM integers WHERE (CASE WHEN i=2 THEN i+1 ELSE i+2 END) IS NULL;
;
logical_opt	<REGEX>:.*EMPTY_RESULT.*

# we can't here, because one of the children of the case has null
;
EXPLAIN SELECT * FROM integers WHERE (CASE WHEN i=2 THEN i+1 ELSE NULL END) IS NULL;
;
logical_opt	<!REGEX>:.*EMPTY_RESULT.*

# now check overflow testing
# this gives an overflow on the RHS
;
SELECT 123::TINYINT + (CASE WHEN i=2 THEN (i+1)::TINYINT ELSE (i+2)::TINYINT END) FROM integers;

# this does not
;
SELECT 122::TINYINT + (CASE WHEN i=2 THEN (i+1)::TINYINT ELSE (i+2)::TINYINT END) FROM integers;
;
125
125
127

;
SELECT * FROM integers WHERE (CASE WHEN i=2 THEN i+1 ELSE i+2 END) IS NULL;
;

;
SELECT * FROM integers WHERE (CASE WHEN i=2 THEN i+1 ELSE NULL END) IS NULL;
;
1
3
