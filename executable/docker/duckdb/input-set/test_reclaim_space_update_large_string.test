# name: test/sql/storage/test_reclaim_space_update_large_string.test
# description: Test that we reclaim space when updating a large string
# group: [storage]

load __TEST_DIR__/test_reclaim_space.db

;
PRAGMA force_checkpoint;

# FIXME: overflow strings are not reclaimed yet when overwritten on updates
mode skip

# create a big string
;
CREATE TABLE test (a VARCHAR);

# length 1000000
;
INSERT INTO test VALUES (repeat('a', 1000000));

;
SELECT LENGTH(SUBSTRING(a, 0, 1000000)) FROM test
;
999999

# checkpoint the string
;
CHECKPOINT

;
SELECT LENGTH(SUBSTRING(a, 0, 1000000)) FROM test
;
999999

# now update by adding one character to the string on every iteration
loop i 0 10

;
UPDATE test SET a=concat(a, 'a')

;
SELECT LENGTH(SUBSTRING(a, 0, 1000000)) FROM test
;
999999

;
CHECKPOINT

;
select total_blocks from pragma_database_size();

;
SELECT LENGTH(SUBSTRING(a, 0, 1000000)) FROM test
;
999999

endloop
