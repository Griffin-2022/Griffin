# name: test/sql/copy/parquet/test_parquet_stats.test
# description: Test statistic propagation for parquet reader
# group: [parquet]

require parquet

;
PRAGMA explain_output = PHYSICAL_ONLY

# empty reference result
;
explain select * from parquet_scan('data/parquet-testing/userdata1.parquet') where false;
;

# verify null stats work
;
explain select * from parquet_scan('data/parquet-testing/userdata1.parquet') where id is null;
;

# verify min/max stats on int cols work
;
explain select * from parquet_scan('data/parquet-testing/userdata1.parquet') where id < 1;
;

;
explain select * from parquet_scan('data/parquet-testing/userdata1.parquet') where id > 1000;
;


# verify min/max stats on double cols work
;
explain select * from parquet_scan('data/parquet-testing/userdata1.parquet') where salary < 12380;
;

;
explain select * from parquet_scan('data/parquet-testing/userdata1.parquet') where salary > 286593;
;

# verify min/max stats on timestamp cols work
;
explain select * from parquet_scan('data/parquet-testing/timestamp.parquet') where time < '2020-10-04';
;

;
explain select * from parquet_scan('data/parquet-testing/timestamp.parquet') where time > '2020-10-06';
;

;
explain select * from parquet_scan('data/parquet-testing/timestamp-ms.parquet') where time < '2020-10-04';
;

;
explain select * from parquet_scan('data/parquet-testing/timestamp-ms.parquet') where time > '2020-10-06';
;

;
explain select * from parquet_scan('data/parquet-testing/data-types.parquet') where timestampval < '2019-11-25';
;

;
explain select * from parquet_scan('data/parquet-testing/data-types.parquet') where timestampval > '2019-11-27';
;

# TODO string comparisions are not pruned yet
# verify min/max stats on string cols work
#query I nosort empty
#explain select * from parquet_scan('data/parquet-testing/userdata1.parquet') where country < 'Aruba';
#----

#query I nosort empty
#explain select * from parquet_scan('data/parquet-testing/userdata1.parquet') where country > 'Zimbabwe';
#----


# see if stats work correctly for globs

;
pragma disable_object_cache


;
explain select time from parquet_scan('data/parquet-testing/timestamp*.parquet') where time > '2020-10-06'
;

;
pragma enable_object_cache


# no stats since there are two files and the cache is on but we have not read all files yet
;
explain select time from parquet_scan('data/parquet-testing/timestamp*.parquet') where time > '2020-10-06'
;

;
select time from parquet_scan('data/parquet-testing/timestamp*.parquet') where time > '2020-10-06'


# but now we should have them
;
explain select time from parquet_scan('data/parquet-testing/timestamp*.parquet') where time > '2020-10-06'
;

;
pragma disable_object_cache

# no stats again
;
explain select time from parquet_scan('data/parquet-testing/timestamp*.parquet') where time > '2020-10-06'
;