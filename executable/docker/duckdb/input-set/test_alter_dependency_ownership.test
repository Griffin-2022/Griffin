# name: test/sql/catalog/dependencies/test_alter_dependency_ownership.test
# description: Tests alter of ownership of sequences
# group: [dependencies]

##TEST: If the table is dropped, then the sequence is also droppped
;
CREATE SEQUENCE sequence1;

;
CREATE TABLE tablename (
    colname integer
);

;
ALTER SEQUENCE sequence1 OWNED BY tablename;

;
DROP TABLE tablename;

;
SELECT nextval('sequence1');

##TEST: If the table is dropped, then the sequence is also droppped, using schemas
;
CREATE SEQUENCE main.sequence1;

;
CREATE TABLE main.tablename (
    colname integer
);

;
ALTER SEQUENCE main.sequence1 OWNED BY main.tablename;

;
DROP TABLE main.tablename;

;
SELECT nextval('main.sequence1');

##TEST: If the owned sequence is dropped with CASCADE, then the table is also dropped
;
CREATE SEQUENCE sequence1;

;
CREATE TABLE tablename (
    colname integer
);

;
ALTER SEQUENCE sequence1 OWNED BY tablename;

;
DROP SEQUENCE sequence1 CASCADE;

;
SELECT * FROM tablename;

##TEST: The owned sequence cannot be dropped without CASCADE
;
CREATE SEQUENCE sequence1;

;
CREATE TABLE tablename (
    colname integer
);

;
ALTER SEQUENCE sequence1 OWNED BY tablename;

;
DROP SEQUENCE sequence1;

;
DROP TABLE tablename;

##TEST: If sequence is already owned by other table throw an error
;
CREATE SEQUENCE sequence1;

;
CREATE TABLE tablename (
    colname integer
);

;
CREATE TABLE tablename2 (
    colname integer
);

;
ALTER SEQUENCE sequence1 OWNED BY tablename;

;
ALTER SEQUENCE sequence1 OWNED BY tablename2;

;
DROP TABLE tablename;

;
DROP TABLE tablename2;

##TEST: If owning the sequence twice shouldn't return any error
;
CREATE SEQUENCE sequence1;

;
CREATE TABLE tablename (
    colname integer
);

;
ALTER SEQUENCE sequence1 OWNED BY tablename;

;
ALTER SEQUENCE sequence1 OWNED BY tablename;

;
DROP TABLE tablename;

##TEST: A table can own many sequences, and when the table is dropped, all sequences are also dropped
;
CREATE SEQUENCE sequence1;

;
CREATE SEQUENCE sequence2;

;
CREATE SEQUENCE sequence3;

;
CREATE TABLE tablename (
    colname integer
);

;
ALTER SEQUENCE sequence1 OWNED BY tablename;

;
ALTER SEQUENCE sequence2 OWNED BY tablename;

;
ALTER SEQUENCE sequence3 OWNED BY tablename;

;
DROP TABLE tablename;

;
SELECT nextval('sequence1');

;
SELECT nextval('sequence2');

;
SELECT nextval('sequence3');

##TEST: When owning a sequence, insertions work normally
;
CREATE SEQUENCE sequence1;

# sequence 2 will not be owned by tablename
;
CREATE SEQUENCE sequence2;

;
CREATE TABLE tablename (
    colname integer DEFAULT nextval('sequence1'),
    colname2 integer DEFAULT nextval('sequence2'),
    colname3 integer,
    colname4 float,
    colname5 string
);

;
ALTER SEQUENCE sequence1 OWNED BY tablename;

;
INSERT INTO tablename VALUES(default, default, 10, 2.0, 'aaaa');

;
INSERT INTO tablename VALUES(default, default, 20, 3.0, 'bbbb');

;
SELECT colname, colname2, colname3, colname4, colname5 FROM tablename;
;
1	1	10	2.0	aaaa
2	2	20	3.0	bbbb

;
DROP TABLE tablename;

;
DROP SEQUENCE sequence2;

##TEST: If we change the name of a table that has an owned sequence, the ownership moves to the new table name
;
CREATE SEQUENCE sequence1;

;
CREATE TABLE tablename (
    colname integer
);

;
ALTER SEQUENCE sequence1 OWNED BY tablename;

;
ALTER TABLE tablename RENAME TO new_tablename;

# Create a new table, with the same name as the old table and try to own the sequence
;
CREATE TABLE tablename (
    colname integer
);

;
ALTER SEQUENCE sequence1 OWNED BY tablename;

;
DROP SEQUENCE sequence1;

# Owning the sequence with the same table shouldn't return any error
;
ALTER SEQUENCE sequence1 OWNED BY new_tablename;

;
DROP TABLE tablename;

;
DROP TABLE new_tablename;

##TEST: If we add a column to a table that has an owned sequence, the ownership remains
;
CREATE SEQUENCE sequence1;

;
CREATE TABLE tablename (
    colname integer
);

;
ALTER SEQUENCE sequence1 OWNED BY tablename;

;
ALTER TABLE tablename ADD COLUMN colname2 integer DEFAULT nextval('sequence1')

;
ALTER SEQUENCE sequence1 OWNED BY tablename;

;
DROP SEQUENCE sequence1;

;
DROP TABLE tablename;

##TEST: If we remove a column to a table that has an owned sequence, the ownership remains
;
CREATE SEQUENCE sequence1;

;
CREATE TABLE tablename (
    colname integer,
    colname2 integer DEFAULT nextval('sequence1')
);

;
ALTER SEQUENCE sequence1 OWNED BY tablename;

;
ALTER TABLE tablename DROP colname2;

;
DROP SEQUENCE sequence1;

;
DROP TABLE tablename;

##TEST: If we alter the type of a column that has the sequence as default value
;
CREATE SEQUENCE sequence1;

;
CREATE TABLE tablename (
    colname integer DEFAULT nextval('sequence1')
);

;
ALTER SEQUENCE sequence1 OWNED BY tablename;

;
ALTER TABLE tablename ALTER colname TYPE float;

;
DROP SEQUENCE sequence1;

;
DROP TABLE tablename;

###TEST: If we have many columns using the sequence as default and drop one by one, the ownership should remain intact
;
CREATE SEQUENCE sequence1;

;
CREATE TABLE tablename (
    colname integer DEFAULT nextval('sequence1'),
    colname2 integer DEFAULT nextval('sequence1'),
    colname3 integer DEFAULT nextval('sequence1'),
    colname4 integer DEFAULT nextval('sequence1')
);

;
ALTER SEQUENCE sequence1 OWNED BY tablename;

;
ALTER TABLE tablename DROP colname4;

;
DROP SEQUENCE sequence1;

;
ALTER TABLE tablename DROP colname3;

;
DROP SEQUENCE sequence1;

;
ALTER TABLE tablename DROP colname2;

;
DROP SEQUENCE sequence1;

;
DROP TABLE tablename;

##TEST: If we drop a table which owns a sequence and then roll back, the ownership should remain
;
CREATE SEQUENCE sequence1;

;
CREATE TABLE tablename (
    colname integer DEFAULT nextval('sequence1')
);

;
ALTER SEQUENCE sequence1 OWNED BY tablename;

;
BEGIN TRANSACTION;

;
DROP TABLE tablename;

;
select nextval('sequence1');

;
ROLLBACK;

;
select nextval('sequence1');
;
1

;
DROP SEQUENCE sequence1;

;
DROP TABLE tablename;

##TEST: View can own a sequence
;
CREATE SEQUENCE sequence1;

;
CREATE VIEW v1_sequence1(a) AS SELECT 42;

;
ALTER SEQUENCE sequence1 OWNED BY v1_sequence1;

;
DROP SEQUENCE sequence1;

;
DROP VIEW v1_sequence1;

;
SELECT nextval('sequence1');

##TEST: Sequence can own a sequence
;
CREATE SEQUENCE sequence1;

;
CREATE SEQUENCE sequence2;

;
ALTER SEQUENCE sequence1 OWNED BY sequence2;

;
DROP SEQUENCE sequence1;

;
DROP SEQUENCE sequence2;

;
SELECT nextval('sequence1');

##TEST: Sequence cant own its owner
;
CREATE SEQUENCE sequence1;

;
CREATE SEQUENCE sequence2;

;
ALTER SEQUENCE sequence1 OWNED BY sequence2;

;
ALTER SEQUENCE sequence2 OWNED BY sequence1;

;
DROP SEQUENCE sequence2;

##TEST: Dependency cycle should throw error
;
CREATE SEQUENCE sequence1;

;
CREATE SEQUENCE sequence2;

;
CREATE SEQUENCE sequence3;

;
CREATE SEQUENCE sequence4;

;
ALTER SEQUENCE sequence2 OWNED BY sequence1;

;
ALTER SEQUENCE sequence3 OWNED BY sequence2;

;
ALTER SEQUENCE sequence1 OWNED BY sequence3;

;
ALTER SEQUENCE sequence3 OWNED BY sequence4;

;
DROP SEQUENCE sequence1;

;
DROP SEQUENCE sequence4;

;
SELECT nextval('sequence1');

;
SELECT nextval('sequence2');

;
SELECT nextval('sequence3');

;
SELECT nextval('sequence4');
