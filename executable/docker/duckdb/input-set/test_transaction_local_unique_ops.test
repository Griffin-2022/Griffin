# name: test/sql/transactions/test_transaction_local_unique_ops.test
# description: Test operations on transaction local data with unique indices
# group: [transactions]

;
PRAGMA enable_verification

# perform different operations on the same data within one transaction
;
BEGIN TRANSACTION

;
CREATE TABLE integers(i INTEGER PRIMARY KEY, j INTEGER)

;
INSERT INTO integers VALUES (1, 3), (2, 3)

;
SELECT * FROM integers ORDER BY 1
;
1	3
2	3

# appending the same value again fails
;
INSERT INTO integers VALUES (1, 2)

;
ROLLBACK

;
BEGIN TRANSACTION

;
CREATE TABLE integers(i INTEGER PRIMARY KEY, j INTEGER)

;
INSERT INTO integers VALUES (1, 3), (2, 3)

;
SELECT * FROM integers ORDER BY 1
;
1	3
2	3

# updating also fails if there is a conflict
;
UPDATE integers SET i=1 WHERE i=2

;
ROLLBACK

;
BEGIN TRANSACTION

;
CREATE TABLE integers(i INTEGER PRIMARY KEY, j INTEGER)

;
INSERT INTO integers VALUES (1, 3), (2, 3)

;
SELECT * FROM integers ORDER BY 1
;
1	3
2	3

# but not if there is no conflict
;
UPDATE integers SET i=3 WHERE i=2

;
COMMIT

;
SELECT * FROM integers ORDER BY 1
;
1	3
3	3

# if we delete, we can insert the value again
;
DELETE FROM integers WHERE i=1

;
SELECT * FROM integers ORDER BY 1
;
3	3

;
INSERT INTO integers VALUES (1, 3)

;
SELECT * FROM integers ORDER BY 1
;
1	3
3	3

