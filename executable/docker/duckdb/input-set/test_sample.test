# name: test/sql/sample/test_sample.test
# description: Test SAMPLE keyword
# group: [sample]

;
PRAGMA enable_verification;

;
CREATE TABLE test (a INTEGER, b INTEGER);

;
INSERT INTO test VALUES (11, 22), (12, 21), (13, 22)

# test various limits using count
;
SELECT COUNT(*) FROM test USING SAMPLE 0
;
0

;
SELECT COUNT(*) FROM test USING SAMPLE 1
;
1

;
SELECT COUNT(*) FROM test USING SAMPLE 1 ROWS
;
1

;
SELECT COUNT(*) FROM test USING SAMPLE 3
;
3

# sample size exceeds input
;
SELECT COUNT(*) FROM test USING SAMPLE 10
;
3

# specify sample
;
SELECT COUNT(*) FROM test USING SAMPLE 3 (reservoir)
;
3

# specify seed
;
SELECT COUNT(*) FROM test USING SAMPLE 3 (reservoir, 3)
;
3

;
SELECT * FROM test USING SAMPLE 10 ORDER BY a, b
;
11	22
12	21
13	22

# sample on a larger data set
;
SELECT COUNT(*) FROM range(10000) USING SAMPLE 5
;
5

# test sample with multiple columns
# we insert the same data in the entire column
;
CREATE TABLE test2 AS SELECT i a, i::VARCHAR b, CONCAT(i, ' - ', i) c FROM repeat(1, 1000) tbl(i)

;
SELECT a, b, c FROM test2 USING SAMPLE 3;
;
1	1	1 - 1
1	1	1 - 1
1	1	1 - 1

# sample in scalar subqueries
;
SELECT (SELECT COUNT(*) FROM test USING SAMPLE 1);
;
1

;
SELECT (SELECT COUNT(*) + tbl.i FROM test USING SAMPLE 1) FROM range(3) tbl(i) ORDER BY i;
;
1
2
3

# negative sample size not allowed
;
SELECT COUNT(*) FROM test USING SAMPLE -1

# must be a number
;
SELECT COUNT(*) FROM test USING SAMPLE 'hello'

;
SELECT COUNT(*) FROM test USING SAMPLE DATE '1992-01-01'

# verify that it is a sample without replacement (i.e. the same row will never occur more than once in the result)
loop i 0 10

;
select count(distinct i) from range(10) tbl(i) using sample 5;
;
5

endloop

# specifying a seed leads to repeatable behavior
loop i 0 10

;
select * from range(100) using sample 10 (reservoir, 250)
;

;
select * from range(100) using sample 10% (bernoulli, 250)
;

;
select * from range(100) using sample 10% (system, 250)
;

endloop

# specify as sample_size, with reservoir sampling this should give us an exact count (i.e. always 10)
loop i 0 10

;
select count(*) from range(100) using sample 10% (reservoir)
;
10

endloop

# we can also use postgres/sqlserver-style tablesample syntax
;
create table integers as select i from range(200) tbl(i);

# default is sample_size, which follows postgres syntax rules
;
select count(*) from integers tablesample reservoir(10);
;
10

;
select count(*) from integers tablesample reservoir(10%);
;
20

;
select count(*) from integers tablesample reservoir(10 percent);
;
20

;
select count(*) from integers tablesample reservoir(10 rows);
;
10

# we can also use the default sampling method
;
select count(*) from integers tablesample(10 rows);
;
10

# we can use our sampling syntax here as well
;
select count(*) from integers tablesample 10;
;
10

;
select count(*) from integers tablesample 10 rows (reservoir);
;
10

;
select count(*) from integers tablesample 10 rows (reservoir, 250);
;
10

# we can also use this with table-producing functions
;
select count(*) from range(200) tablesample reservoir(10%);
;
20

# and subqueries
;
select count(*) from (select * from range(200)) tbl(i) tablesample reservoir(10%);
;
20

# specifying a seed leads to repeatable behavior
loop i 0 10

;
select * from range(100) tablesample reservoir(10 rows) repeatable(250)
;

;
select * from range(100) tablesample bernoulli(10%) repeatable(250)
;

;
select * from range(100) tablesample system(10%) repeatable(250)
;

endloop

;
select count(*) from range(1000) using sample reservoir(0.01%);
;
0

;
select count(*) from range(1000) using sample reservoir(0.1%);
;
1

# reservoir sample from a larger dataset
;
select count(*) from range(200000) tablesample reservoir(90%);
;
180000

# cannot use bernoulli or system sampling with X number of rows
;
select * from integers using sample bernoulli(5 rows);

;
select * from integers using sample system(5 rows);

# sample_size is out of range
;
select * from integers using sample 10000%;
