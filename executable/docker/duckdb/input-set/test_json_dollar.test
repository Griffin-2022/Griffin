# name: test/sql/json/test_json_dollar.test
# description: Test JSON $ notation
# group: [json]

require json

;
pragma enable_verification

;
select json_extract('{"my_field": "duck"}', '$.my_field')
;
"duck"

;
select json_extract('[0, 1, 2]', '$[1]')
;
1

;
select json_extract('[[1]]', '$[0][0]')
;
1

;
create table test (j varchar, q varchar)

;
insert into test values ('{"my_field": {"my_nested_field": ["goose", "duck"]}}', '$.my_field.my_nested_field[0]')

;
select json_extract(j, '$.my_field.my_nested_field[0]') from test
;
"goose"

;
select json_extract(j, '$.my_field.my_nested_field[#-1]') from test
;
"duck"

;
select json_extract(j, '$.my_field.my_nested_field[#-2]') from test
;
"goose"

;
select json_extract(j, '$.my_field.my_nested_field[#-3]') from test
;
NULL

;
select json_extract(j, '$.my_field.my_nested_field[#]') from test
;
NULL

;
select json_extract(j, q) from test
;
"goose"

;
select json_extract('{"my_field": [{"my_nested_field": ["duck", "goose"]}]}', '$.my_field[0].my_nested_field[0]')
;
"duck"

;
select json_extract('{"my_field": [{"my_nested_field": ["duck", "goose"]}]}', '$.my_field[#-1].my_nested_field[#-1]')
;
"goose"

# some NULLs

;
select json_extract(j, '$.my_field.my_nested_field.3') from test
;
NULL

# path error
;
select json_extract('{"a": {"b": "c"}}', '$[]');

;
select json_extract(j, '$.my_field[my_nested_field[#-3]') from test

;
select json_extract(j, '$.my_field.my_nested_field[!]') from test

;
select json_extract('{"a": {"b": "c"}}', '$.a..');

;
select json_extract('{"a": {"b": "c"}}', '$[[');

;
select json_extract('{"a": {"b": "c"}}', '$[.');

;
select json_extract('{"a": {"b": "c"}}', '$]');
