# name: test/sql/cte/recursive_array_slice.test
# description: Issue #3005: array_slice prevents row values to be used more than once
# group: [cte]

;
PRAGMA enable_verification

;
CREATE TABLE p(loc int8);

;
INSERT INTO p VALUES (1);

;
WITH RECURSIVE t(y, arr) AS
(
  SELECT 1, array[1,2,3,4,5,6]
    UNION ALL
  SELECT y+1, arr[:loc]
  FROM   t, p
  WHERE y < 10
) SELECT * FROM t;
;
1	[1, 2, 3, 4, 5, 6]
2	[1]
3	[1]
4	[1]
5	[1]
6	[1]
7	[1]
8	[1]
9	[1]
10	[1]

;
WITH RECURSIVE t(y, arr) AS
(
  SELECT 1, array[1,2,3,4,5,6]
    UNION ALL
  SELECT y+1, arr
  FROM   t, p
  WHERE y < 10
    AND y = loc
) SELECT * FROM t;
;
1	[1, 2, 3, 4, 5, 6]
2	[1, 2, 3, 4, 5, 6]

;
WITH RECURSIVE t(y, arr) AS
(
  SELECT 1, array[1,2,3,4,5,6]
    UNION ALL
  SELECT y+1, arr[:loc]
  FROM   t, p
  WHERE y < 10
    AND y = loc
) SELECT * FROM t;
;
1	[1, 2, 3, 4, 5, 6]
2	[1]

;
WITH RECURSIVE t(arr) AS
(
  SELECT array[1,2,3,4,5,6]
    UNION ALL
  SELECT  arr[arr[1]+1:6]
  FROM   t
  WHERE arr[1] < 6
) SELECT * FROM t;
;
[1, 2, 3, 4, 5, 6]
[2, 3, 4, 5, 6]
[4, 5, 6]
[]
