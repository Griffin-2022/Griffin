# name: test/sql/catalog/function/test_cte_macro.test
# description: Test Macro with CTE
# group: [function]

;
PRAGMA enable_verification

;
CREATE TABLE integers (a INT)

;
INSERT INTO integers VALUES (1)

;
CREATE MACRO parameterized_cte(a) AS (WITH cte AS (SELECT a AS answer) SELECT answer FROM cte)

;
SELECT parameterized_cte(42)
;
42

;
CREATE MACRO in_with_cte(i) AS i IN (WITH cte AS (SELECT a AS answer FROM integers) SELECT answer FROM cte)

;
SELECT in_with_cte(1)
;
1

;
SELECT in_with_cte(2)
;
0

;
CREATE MACRO plus42(a) AS (WITH cte AS (SELECT 42 AS answer) SELECT answer + a FROM cte)

;
SELECT plus42(42)
;
84

;
SELECT plus42(a) FROM integers
;
43

# macro parameters should be contained within the function call (so 42 + 3 + 1)
;
SELECT plus42(3) + a FROM integers
;
46

# we should not be able to query the CTE from outside the function call
;
SELECT plus42(42) + answer FROM cte;

;
CREATE MACRO plus1(a) AS (WITH tbl AS (SELECT 1 AS one) SELECT one + a FROM tbl)

;
SELECT plus1(3)
;
4

;
SELECT plus42(a) + plus1(a) FROM integers;
;
45

;
CREATE MACRO deep_cte(param) AS (
    WITH cte1 AS (
        WITH cte2 AS (
            WITH cte3 AS (
                WITH cte4 AS (
                    SELECT param AS d
                )
                SELECT d AS c FROM cte4
            )
            SELECT c AS b FROM cte3
        )
        SELECT b AS a FROM cte2
    )
    SELECT a FROM cte1
)

;
SELECT deep_cte(42)
;
42
