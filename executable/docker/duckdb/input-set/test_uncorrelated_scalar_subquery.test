# name: test/sql/subquery/scalar/test_uncorrelated_scalar_subquery.test
# description: Test uncorrelated subqueries
# group: [scalar]

;
PRAGMA enable_verification

;
CREATE TABLE integers(i INTEGER)

;
INSERT INTO integers VALUES (1), (2), (3), (NULL)

# scalar subqueries
;
SELECT * FROM integers WHERE i=(SELECT 1)
;
1

;
SELECT * FROM integers WHERE i=(SELECT SUM(1))
;
1

;
SELECT * FROM integers WHERE i=(SELECT MIN(i) FROM integers)
;
1

;
SELECT * FROM integers WHERE i=(SELECT MAX(i) FROM integers)
;
3

;
SELECT *, (SELECT MAX(i) FROM integers) FROM integers ORDER BY i
;
NULL	3
1	3
2	3
3	3

# group by on subquery
;
SELECT (SELECT 42) AS k, MAX(i) FROM integers GROUP BY k
;
42	3

# subquery as parameter to aggregate
;
SELECT i, MAX((SELECT 42)) FROM integers GROUP BY i ORDER BY i
;
NULL	42
1	42
2	42
3	42

# scalar subquery returning zero results should result in NULL
;
SELECT (SELECT * FROM integers WHERE i>10) FROM integers
;
NULL
NULL
NULL
NULL

# return more than one row in a scalar subquery
# controversial: in postgres this gives an error
# but SQLite accepts it and just uses the first value
# we choose to agree with SQLite here
;
SELECT * FROM integers WHERE i=(SELECT i FROM integers WHERE i IS NOT NULL ORDER BY i)
;
1

# i.e. the above query is equivalent to this query
;
SELECT * FROM integers WHERE i=(SELECT i FROM integers WHERE i IS NOT NULL ORDER BY i LIMIT 1)
;
1

# returning multiple columns should fail though
;
SELECT * FROM integers WHERE i=(SELECT 1, 2)

;
SELECT * FROM integers WHERE i=(SELECT i, i + 2 FROM integers)

# but not for EXISTS queries!
;
SELECT * FROM integers WHERE EXISTS (SELECT 1, 2)
;
1
2
3
NULL

;
SELECT * FROM integers WHERE EXISTS (SELECT i, i + 2 FROM integers)
;
1
2
3
NULL

# SELECT * should be fine if the star only expands to a single column
;
SELECT (SELECT * FROM integers WHERE i=1)
;
1

# but not if the star expands to more than one column!
;
SELECT (SELECT * FROM integers i1, integers i2)

#  uncorrelated subquery in SELECT
;
SELECT (SELECT i FROM integers WHERE i=1)
;
1

;
SELECT * FROM integers WHERE i > (SELECT i FROM integers WHERE i=1) ORDER BY 1
;
2
3

