# name: test/sql/delete/test_segment_deletes.test
# description: Test deletions
# group: [delete]

;
CREATE TABLE a(i INTEGER);

# insert the values [0, 1, 2, .. 1022, 1023] repeatedly
# however, make sure the order that we insert them is 
loop i 0 20

;
INSERT INTO a SELECT * FROM range(0, 1024, 1);

endloop

# verify the count

;
SELECT COUNT(*) FROM a
;
20480

# we test the values 0, 1, 1022 and 1023
# for every tested value, delete it and then rollback

# value = 0
;
BEGIN TRANSACTION;
DELETE FROM a WHERE i=0;

# verify the deleted count
;
SELECT COUNT(*) FROM a
;
20460

;
ROLLBACK

# verify the initial count
;
SELECT COUNT(*) FROM a
;
20480

# value = 1
;
BEGIN TRANSACTION;
DELETE FROM a WHERE i=1;

# verify the deleted count
;
SELECT COUNT(*) FROM a
;
20460

;
ROLLBACK

# verify the initial count
;
SELECT COUNT(*) FROM a
;
20480

# value = 1022
;
BEGIN TRANSACTION;
DELETE FROM a WHERE i=1022;

# verify the deleted count
;
SELECT COUNT(*) FROM a
;
20460

;
ROLLBACK

# verify the initial count
;
SELECT COUNT(*) FROM a
;
20480

# value = 1023
;
BEGIN TRANSACTION;
DELETE FROM a WHERE i=1023;

# verify the deleted count
;
SELECT COUNT(*) FROM a
;
20460

;
ROLLBACK

# verify the initial count
;
SELECT COUNT(*) FROM a
;
20480

# now, for every tested value, delete it in a separate connection and verify the count
# con2 -> 0
;
BEGIN TRANSACTION;

;
DELETE FROM a WHERE i=0;

;
SELECT COUNT(*) FROM a;
;
20460

# con3 -> 1
;
BEGIN TRANSACTION;

;
DELETE FROM a WHERE i=1;

;
SELECT COUNT(*) FROM a;
;
20460

# con4 -> 1022
;
BEGIN TRANSACTION;

;
DELETE FROM a WHERE i=1022;

;
SELECT COUNT(*) FROM a;
;
20460

# con5 -> 1023
;
BEGIN TRANSACTION;

;
DELETE FROM a WHERE i=1023;

;
SELECT COUNT(*) FROM a;
;
20460

# con1 still has the original count
;
SELECT COUNT(*) FROM a;
;
20480

# until we update the other transactions
;
COMMIT

;
COMMIT

;
COMMIT

;
COMMIT

# now the count is updated
;
SELECT COUNT(*) FROM a;
;
20400